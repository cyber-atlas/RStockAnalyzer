---
title: "ds202_final"
author: "Blake Inderski"
date: "4/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("dplyr")
library("tidyr")
library("tidyverse")
library("ggplot2")
library("readxl")
library("ggrepel")
library("RColorBrewer")
library("padr")

#install.packages("tseries")
#https://cran.r-project.org/src/contrib/Archive/forecast/
#install.packages("uroot")
#install.packages("nnet")
#install.packages("~/Downloads/forecast_8.4.tar", repos = NULL)
#https://cran.r-project.org/src/contrib/Archive/quadprog/
#install.packages("~/Downloads/quadprog_1.5-5.tar", repos = NULL)
#install.packages("tidyquant")
library("tidyquant")
#install.packages("quantmod")
library("quantmod")
#install.packages("magrittr")
library('magrittr')
```

The start and endates for these samples. It pulls data based on the day. I need to see if it is possible to find stuff for intraday trading, but this helps us get started for now. 


```{r}
#Define start and End dates
start <- as.Date("2018-01-01")
end <- as.Date("2019-04-01")
```

Get some of the symbols that we will be looking at in the timefram that we are looking at. 

```{r}
?getSymbols
getSymbols(c("BA", "EADSF"), src="yahoo", from = start, to = end)
```


The data is saved as an xts object. From what I could tell it is very similar to a dataframe except it has more fields. Also showing some of the data.


Let's plot the stock data

The close prices of Apple over the given timeframe
```{r}
plot(BA[, "BA.Close"], main = "BA")
plot(EADSF[, "EADSF.Close"], main = "EADSF")
```

Another way to plot, this time using the AMD close prices
```{r}
#https://www.axios.com/boeing-737-max-crash-what-know-a5087b8e-1787-4de5-bece-d1350d5695cf.html
#On 29 October 2018, the Boeing 737 MAX 8 operating the route crashed into the Java Sea 12 minutes after takeoff, killing all 189 passengers and crew.
#On 10 March 2019, the Boeing 737 MAX 8 aircraft which operated the flight crashed near the town of Bishoftu six minutes after takeoff, killing all 157 people aboard.

#https://stackoverflow.com/questions/3386850/how-can-i-change-xts-to-data-frame-and-keep-index
ba_df <- data.frame(date=index(BA), coredata(BA)) %>% 
  mutate(BA.day_difference = BA.High-BA.Low) %>%
  mutate(BA.scale_max = BA.Close/max(BA.Close))
eadsf_df <- data.frame(date=index(EADSF), coredata(EADSF)) %>% 
  mutate(EADSF.day_difference = EADSF.High-EADSF.Low) %>%
  mutate(EADSF.scale_max = EADSF.Close/max(EADSF.Close))


ggplot(ba_df, aes(x=date, y=BA.scale_max))+
  coord_cartesian(xlim=c(start+20, end-20), ylim=c(0.66, 1))+
  geom_line(color="#0039a6")+
  geom_line(data=eadsf_df, aes(y=EADSF.scale_max), color="#74d2e7")+
  scale_x_date(date_labels = "%b %y", date_breaks = "1 month")+
  ylab("closing value")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_vline(xintercept = as.Date("2018-10-29"), size=0.5, linetype="dotted")+
  geom_vline(xintercept = as.Date("2019-03-10"), size=0.5, linetype="dotted")+
  annotate("text", x=as.Date("2018-10-29"), 
           y=0.65, label="Lion Air 737 Max 8", angle=90, vjust=-0.5, hjust=0, size=3)+
  annotate("text", x=as.Date("2019-03-10"), 
           y=0.65, label="Ethiopian Airlines 737 Max 8", angle=90, vjust=-0.5, hjust=0, size=3)

ggplot(ba_df, aes(x=date, y=BA.day_difference/max(ba_df$BA.Close)))+
  coord_cartesian(xlim=c(start+20, end-20), ylim=c(0, 0.085))+
  geom_line(color="#0039a6")+
  geom_line(data=eadsf_df, aes(y=EADSF.day_difference/max(eadsf_df$EADSF.Close)), color="#74d2e7")+
  scale_x_date(date_labels = "%b %y", date_breaks = "1 month")+
  ylab("daily volatility")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_vline(xintercept = as.Date("2018-10-29"), size=0.5, linetype="dotted")+
  geom_vline(xintercept = as.Date("2019-03-10"), size=0.5, linetype="dotted")+
  #MAX 8 crash dates
  annotate("text", x=as.Date("2018-10-29"), 
           y=0.0875, label="Lion Air 737 Max 8", angle=90, vjust=-0.5, hjust=1, size=3)+
  annotate("text", x=as.Date("2019-03-10"), 
           y=0.0875, label="Ethiopian Airlines 737 Max 8", angle=90, vjust=-0.5, hjust=1, size=3)+
  #trade volatility inflection points of interest
  annotate("text", x=as.Date("2018-02-05"), 
           y=32.609985/max(ba_df$BA.Close), label="A", vjust=-0.5, hjust=0.5, size=3)+
  annotate("text", x=as.Date("2018-04-24"), 
           y=24.390014/max(ba_df$BA.Close), label="B", vjust=-0.5, hjust=0.5, size=3)+
  annotate("text", x=as.Date("2018-11-20"), 
           y=25.570008/max(ba_df$BA.Close), label="C", vjust=-0.5, hjust=0.5, size=3)+
  annotate("text", x=as.Date("2018-12-26"), 
           y=21.619995/max(ba_df$BA.Close), label="D", vjust=-0.5, hjust=0.5, size=3)
```

Try to find dates corresponding to Boeing volatility inflection points.
#https://boeing.mediaroom.com/2018-02-05-Boeing-Debuts-First-737-MAX-7
#https://boeing.mediaroom.com/2018-04-24-Boeing-Ryanair-Announce-Order-for-25-737-MAX-8s
#https://www.cnbc.com/2018/11/20/boeing-shares-fall-after-cancelling-conference-call-on-737-issues.html
#https://www.defensenews.com/land/2018/12/26/heres-the-first-look-at-the-sikorsky-boeing-defiant-helicopter/


```{r}
#https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ04-charting-with-tidyquant.html
bband_n <- 20
ba_df <- mutate(ba_df, BA.SMA = SMA(unlist(ba_df[,2]), n=bband_n)) %>% 
  #mutate(below_SMA = BA.Close < BA.SMA)
  mutate(below_SMA = ifelse(BA.Close < BA.SMA, 1000, 0))

pad_ba_df <- ba_df %>% pad
keep_SMA <- 0
for (row in 1:nrow(pad_ba_df)) {
  SMA <- pad_ba_df[row, "below_SMA"]
  if(!is.na(SMA)) {
    #print(paste("if",keep_SMA,sep=":"))
    keep_SMA <- SMA
  } else if(keep_SMA == 1000) {
    #print(paste("elseif",keep_SMA,sep=":"))
    pad_ba_df[row, "below_SMA"] <- 1000
  }
}

ggplot(ba_df, aes(x = date, y = BA.Close, open = BA.Open, 
                  high = BA.High, low = BA.Low, close = BA.Close))+
  coord_cartesian(expand=FALSE, xlim=c(start, end), #+48, end-22),
                  ylim=c(min(ba_df$BA.Close)-10, max(ba_df$BA.Close)+30))+
  geom_bar(data=pad_ba_df, aes(y=below_SMA), color="#ffb3b3", stat="identity", width=1)+
  geom_line(color="#0039a6")+ #geom_candlestick()+
  geom_bbands(ma_fun = SMA, sd = 2, n = bband_n)+
  labs(title = "BA Chart", 
       subtitle = "BBands with SMA Applied", 
       y = "Closing Price", x = "date")+ 
  #theme_tq()
  scale_x_date(date_labels = "%b %y", date_breaks = "1 month")+
  ylab("closing value")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))
```



